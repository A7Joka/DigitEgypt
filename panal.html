<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>مولد كود JokaMatch</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #151825;
      color: #fff;
      padding: 30px;
      direction: rtl;
    }

    .container {
      max-width: 800px;
      margin: auto;
    }

    input, textarea, button {
      font-family: inherit;
      border: none;
      border-radius: 8px;
      padding: 10px;
    }

    input, textarea {
      background: #1e2133;
      color: #fff;
    }

    button {
      background: #39DBBF;
      cursor: pointer;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    .match-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 15px;
    }

    .match-checkbox {
      margin-top: 6px;
    }

    .inline-match-item {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      background: rgba(255,255,255,0.05);
      border: 1px solid #2e3247;
      border-radius: 10px;
      padding: 12px;
      color: var(--text, #BFC3D4);
      position: relative;
    }

    .team-block {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .team-block img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
    }

    .match-x {
      font-weight: bold;
      font-size: 16px;
      margin: 0 10px;
    }

    .cup-title {
      width: 100%;
      text-align: center;
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .input-link {
      width: 100%;
      margin-top: 10px;
    }

    #finalCode {
      width: 100%;
      background: #1e2133;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      direction: ltr;
      font-size: 14px;
      resize: none;
    }
    .section-title {
  padding: 0 15px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.matches-date-filter {
  display: flex;
  align-items: center;
  gap: 10px;
}
.date-next-prev {
  background: #1e2133;
  color: #fff;
  border: none;
  border-radius: 6px;
  width: 30px;
  height: 30px;
  font-size: 18px;
  cursor: pointer;
}
.filtered-date {
  font-weight: bold;
  font-size: 14px;
  color: #39DBBF;
}

  </style>
</head>
<body>
  <div class="container">
    <h2>🎯 مولد كود JokaMatch</h2>
    
    <div id="login-area">
      <input type="password" id="password" style="width:68%" placeholder="ادخل كلمة المرور">
      <button id="login-btn" style="width:29%">تسجيل الدخول</button>
    </div>

    <div id="generator-area" class="hidden">
      <input type="text" id="apiKeyInput" style="width:68%" placeholder="ادخل كود API Key">
      <button id="verify-btn" style="width:29%">تحقق من الكود</button>

      <div id="matches-area" class="hidden">
        <div class="championship-wrap important-matches">
  <div class="section-title">
    <h3>📅 فلاتر المباريات</h3>
    <div class="section-actions">
      <div class="matches-date-filter">
        <div class="inline-date-filter">
          <button id="prev-date" class="date-next-prev" title="اليوم السابق">⬅️</button>
          <span id="displayed-date" class="filtered-date" data-date="">--</span>
          <button id="next-date" class="date-next-prev" title="اليوم التالي">➡️</button>
        </div>
        <input type="date" id="custom-date" style="margin-right:10px; background:#1e2133; color:#fff; border:none; border-radius:6px;">
      </div>
    </div>
  </div>
  <div id="matchCounter" style="margin-bottom: 16px; font-size: 14px; color:#ccc;"></div>
</div>


<div id="matchCounter" style="margin-bottom: 12px; font-size: 14px;"></div>

        <h3>✅ حدد المباريات وضع الروابط:</h3>
        <div id="match-list"></div>
        <button id="generate-btn" style="width:100%">🎉 توليد الكود</button>

        <div style="position: relative;">
          <textarea id="finalCode" style="width:97%" rows="6" readonly onclick="this.select();"></textarea>
          <button onclick="copyFinalCode()" style="position:absolute; bottom:10px; left:10px;">📋 نسخ الكود</button>
        </div>
      </div>
    </div>
  </div>

<script>
const PASSWORD = "joka2025";

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("login-btn").addEventListener("click", () => {
    const pass = document.getElementById("password").value;
    if (pass === PASSWORD) {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("generator-area").classList.remove("hidden");
    } else {
      alert("❌ كلمة المرور غير صحيحة");
    }
  });

  document.getElementById("verify-btn").addEventListener("click", () => {
    const key = document.getElementById("apiKeyInput").value.trim();
    if (!key) return alert("⚠️ أدخل كود صحيح");
    fetchMatches("today");
  });

  document.getElementById("generate-btn").addEventListener("click", generateCode);
});

function generateCode() {
  const map = {};
  document.querySelectorAll(".match-wrapper").forEach(wrapper => {
    const id = wrapper.dataset.id;
    const chk = document.getElementById(`chk-${id}`);
    const input = document.getElementById(`link-${id}`);
    map[id] = chk.checked ? (input.value.trim() || "#") : "--hide--";
  });

  const json = JSON.stringify(map);
  const encoded = btoa(json);
  const apiKey = document.getElementById("apiKeyInput").value.trim();

  const final = [
    "<JokaMatch>",
    `<div day="today" theme="dark" flt="1" data-links="${encoded}" style="display:block;text-align:center;"></div>`,
    "</JokaMatch>",
    `<script src="https://eng3body0.github.io/DigitEgypt/tm.js" api-key="${apiKey}"><\/script>`
  ].join("\n");

  document.getElementById("finalCode").value = final;
}

function copyFinalCode() {
  navigator.clipboard.writeText(document.getElementById("finalCode").value).then(() => {
    alert("✅ تم نسخ الكود!");
  });
}

async function generateSignature(str) {
  const buffer = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest("SHA-256", buffer);
  return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, "0")).join("");
}

async function fetchMatches(day) {
  const SECRET = "NinJ0kaKey";
  const ts = Math.floor(Date.now() / 1000);
  const sig = await generateSignature(`${ts}:${SECRET}`);
  const proxyUrl = `https://joka.ninjoka.workers.dev/?ts=${ts}&sig=${sig}&date=${encodeURIComponent(day)}`;

  try {
    const res = await fetch(proxyUrl, {
      headers: {
        "X-From-Joka": "YES"
      }
    });
    const rawText = await res.text();
    const json = JSON.parse(rawText.replace(/^NinJoka\((.*)\)$/, "$1"));
    if (!json.matches || !Array.isArray(json.matches)) throw new Error("❌ لا توجد مباريات");
    renderMatches(json.matches);
  } catch (e) {
    alert("⚠️ حدث خطأ أثناء جلب المباريات");
    console.error(e);
  }
}

function renderMatches(matches) {
  document.getElementById("matchCounter").textContent = `✅ تم عرض ${matches.length} مباراة`;
  const list = document.getElementById("match-list");
  list.innerHTML = "";
  document.getElementById("matches-area").classList.remove("hidden");

  matches.forEach(match => {
    const matchId = match["Match-id"];
    const cup = match["Cup-Name"] || "بطولة غير معروفة";
    const right = match["Team-Right"];
    const left = match["Team-Left"];

    const wrapper = document.createElement("div");
    wrapper.className = "match-wrapper";
    wrapper.dataset.id = matchId;

    wrapper.innerHTML = `
      <div class="match-checkbox">
        <input type="checkbox" id="chk-${matchId}" onchange="toggleInput('${matchId}')">
      </div>
      <div class="inline-match-item">
        <div class="cup-title">🏆 ${cup}</div>
        <div class="team-block"><img src="${right.Logo}"><span>${right.Name}</span></div>
        <div class="match-x">X</div>
        <div class="team-block"><span>${left.Name}</span><img src="${left.Logo}"></div>
        <div class="input-link hidden" id="card-${matchId}">
          <input type="text" style="width:97%" id="link-${matchId}" placeholder="رابط المباراة">
        </div>
      </div>
    `;
    list.appendChild(wrapper);
  });
}

function toggleInput(id) {
  const inputBox = document.getElementById(`card-${id}`);
  const chk = document.getElementById(`chk-${id}`);
  inputBox.classList.toggle("hidden", !chk.checked);
}
  function handleDateChange() {
  const val = document.getElementById("dateSelector").value;
  const dateInput = document.getElementById("customDate");
  if (val === "custom") {
    dateInput.classList.remove("hidden");
    if (dateInput.value) fetchMatches(dateInput.value);
  } else {
    dateInput.classList.add("hidden");
    fetchMatches(val);
  }
}
let currentDate = new Date();

function updateDateDisplay() {
  const options = { day: "numeric", month: "long", year: "numeric" };
  document.getElementById("displayed-date").textContent = currentDate.toLocaleDateString("ar-EG", options);
  document.getElementById("displayed-date").dataset.date = currentDate.toISOString().split("T")[0];
  document.getElementById("custom-date").value = currentDate.toISOString().split("T")[0];
}

function loadMatchesByDate() {
  const formatted = currentDate.toISOString().split("T")[0];
  fetchMatches(formatted);
}

document.getElementById("prev-date").addEventListener("click", () => {
  currentDate.setDate(currentDate.getDate() - 1);
  updateDateDisplay();
  loadMatchesByDate();
});

document.getElementById("next-date").addEventListener("click", () => {
  currentDate.setDate(currentDate.getDate() + 1);
  updateDateDisplay();
  loadMatchesByDate();
});

document.getElementById("custom-date").addEventListener("change", e => {
  currentDate = new Date(e.target.value);
  updateDateDisplay();
  loadMatchesByDate();
});

// أول مرة
updateDateDisplay();

</script>
</body>
</html>

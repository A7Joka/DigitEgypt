<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù…ÙˆÙ„Ø¯ ÙƒÙˆØ¯ JokaMatch</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #151825;
      color: #fff;
      padding: 30px;
      direction: rtl;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-family: inherit;
      border: none;
    }
    input, textarea {
      background: #1e2133;
      color: #fff;
    }
    button {
      background: #39DBBF;
      cursor: pointer;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .match-row {
      background: #1e2133;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
    }
    .match-card {
      width: 100%;
      margin-top: 10px;
      background: #26293c;
      padding: 10px;
      border-radius: 8px;
    }
    .code-output {
      background: #1e2133;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      direction: ltr;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ¯ Ù…ÙˆÙ„Ø¯ ÙƒÙˆØ¯ JokaMatch</h2>
    
    <div id="login-area">
      <input type="password" id="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button id="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="generator-area" class="hidden">
      <input type="text" id="apiKeyInput" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ API Key">
      <button id="verify-btn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>

      <div id="matches-area" class="hidden">
        <h3>âœ… Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆØ¶Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·:</h3>
        <div id="match-list"></div>
        <button id="generate-btn">ğŸ‰ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>

        <div style="position: relative;">
          <textarea id="finalCode" class="code-output" rows="6" readonly onclick="this.select();"></textarea>
          <button onclick="copyFinalCode()" style="position:absolute; bottom:10px; left:10px; padding:6px 12px; background:#39DBBF; border:none; border-radius:6px; color:#fff; cursor:pointer;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PASSWORD = "joka2025";

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("login-btn").addEventListener("click", () => {
        const pass = document.getElementById("password").value;
        if (pass === PASSWORD) {
          document.getElementById("login-area").classList.add("hidden");
          document.getElementById("generator-area").classList.remove("hidden");
        } else {
          alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        }
      });

      document.getElementById("verify-btn").addEventListener("click", () => {
        const key = document.getElementById("apiKeyInput").value.trim();
        if (!key) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ØµØ­ÙŠØ­");
        fetchMatches("today");
      });

      document.getElementById("generate-btn").addEventListener("click", generateCode);
    });

    function generateCode() {
      const map = {};
      const checkboxes = document.querySelectorAll("input[type='checkbox']");

      checkboxes.forEach(chk => {
        const id = chk.id.replace("chk-", "");
        const isChecked = chk.checked;
        const linkInput = document.getElementById(`link-${id}`);
        const value = isChecked ? (linkInput?.value.trim() || "#") : "--hide--";
        map[id] = value;
      });

      const json = JSON.stringify(map);
      const encoded = btoa(json);
      const apiKey = document.getElementById("apiKeyInput").value.trim();

      const final = [
        "<JokaMatch>",
        `<div day="today" theme="dark" flt="1" data-links="${encoded}" style="display:block;text-align:center;"></div>`,
        "</JokaMatch>",
        `<script src="https://eng3body0.github.io/DigitEgypt/tm.js" api-key="${apiKey}"><\/script>`
      ].join("\n");

      document.getElementById("finalCode").value = final;
    }

    function copyFinalCode() {
      const code = document.getElementById("finalCode").value;
      navigator.clipboard.writeText(code).then(() => {
        alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!");
      });
    }

    async function generateSignature(str) {
      const buffer = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest("SHA-256", buffer);
      return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function fetchMatches(day) {
      const SECRET = "NinJ0kaKey";
      const ts = Math.floor(Date.now() / 1000);
      const sig = await generateSignature(`${ts}:${SECRET}`);
      const proxyUrl = `https://joka.ninjoka.workers.dev/?ts=${ts}&sig=${sig}&date=${encodeURIComponent(day)}`;

      try {
        const res = await fetch(proxyUrl, {
          headers: {
            "X-From-Joka": "YES"
          }
        });
        const rawText = await res.text();
        const json = JSON.parse(rawText.replace(/^NinJoka\((.*)\)$/, "$1"));
        if (!json.matches || !Array.isArray(json.matches)) {
          throw new Error("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª");
        }
        renderMatches(json.matches);
      } catch (e) {
        alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª");
        console.error(e);
      }
    }

    function renderMatches(matches) {
      const list = document.getElementById("match-list");
      list.innerHTML = "";
      document.getElementById("matches-area").classList.remove("hidden");

      matches.forEach(match => {
        const matchId = match["Match-id"];
        const right = match["Team-Right"];
        const left = match["Team-Left"];
        const cup = match["Cup-Name"] || "Ø¨Ø·ÙˆÙ„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";

        const row = document.createElement("div");
        row.className = "match-row";
        row.innerHTML = `
          <input type="checkbox" id="chk-${matchId}" onchange="toggleMatchCard('${matchId}')">
          <label for="chk-${matchId}"><div id="card-${matchId}">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="text-align:center;">
                <img src="${right.Logo}" alt="${right.Name}" style="width:30px; height:30px;"><br>
                <small>${right.Name}</small>
              </div>
              <div style="font-weight:bold;">Ã—</div>
              <div style="text-align:center;">
                <img src="${left.Logo}" alt="${left.Name}" style="width:30px; height:30px;"><br>
                <small>${left.Name}</small>
              </div>
            </div>
            <p style="text-align:center; font-size:13px; color:#aaa;">ğŸ† ${cup}</p>
          </div>
          </label>
          <div id="card-${matchId}" class="match-card hidden">
            <input type="text" id="link-${matchId}" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©">
          </div>
        `;
        list.appendChild(row);
      });
    }

    function toggleMatchCard(id) {
      const card = document.getElementById(`card-${id}`);
      const checked = document.getElementById(`chk-${id}`).checked;
      if (checked) {
        card.classList.remove("hidden");
      } else {
        card.classList.add("hidden");
      }
    }
  </script>
</body>
</html>
